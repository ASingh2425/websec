
import React, { useState } from 'react';
import { Vulnerability, Severity } from '../types';
import { ChevronDown, AlertCircle, Terminal, CheckCircle, Copy, ShieldAlert, AlertTriangle, Info, ShieldCheck, HelpCircle, Briefcase, Lock } from 'lucide-react';
import { securityService } from '../services/securityService';
import { PricingModal } from './PricingModal';

interface Props {
  vulnerabilities: Vulnerability[];
}

const VulnerabilityItem: React.FC<{ vuln: Vulnerability; isOpen: boolean; onToggle: () => void }> = ({ vuln, isOpen, onToggle }) => {
    const [copied, setCopied] = useState(false);
    const [showPricing, setShowPricing] = useState(false);
    const plan = securityService.getCurrentPlan();

    const copyCode = (e: React.MouseEvent) => {
        e.stopPropagation();
        navigator.clipboard.writeText(vuln.fixCode);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };

    const getSeverityConfig = (severity: Severity) => {
        switch (severity) {
          case Severity.CRITICAL: 
            return { color: 'text-rose-400', bg: 'bg-rose-500/10', border: 'border-rose-500/20', icon: ShieldAlert, label: 'Immediate Action' };
          case Severity.HIGH: 
            return { color: 'text-orange-400', bg: 'bg-orange-500/10', border: 'border-orange-500/20', icon: AlertTriangle, label: 'High Priority' };
          case Severity.MEDIUM: 
            return { color: 'text-amber-400', bg: 'bg-amber-500/10', border: 'border-amber-500/20', icon: AlertCircle, label: 'Warning' };
          case Severity.LOW: 
            return { color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', icon: ShieldCheck, label: 'Low Risk' };
          default: 
            return { color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20', icon: Info, label: 'Info' };
        }
    };

    const config = getSeverityConfig(vuln.severity);
    const Icon = config.icon;

    return (
        <div className="group mb-4">
          <PricingModal isOpen={showPricing} onClose={() => setShowPricing(false)} onPlanUpdated={() => window.location.reload()} />
          <div 
            onClick={onToggle}
            className={`flex items-center gap-4 p-5 rounded-xl cursor-pointer transition-all border relative overflow-hidden ${
               isOpen 
                ? `bg-cyber-card border-cyber-primary/40 shadow-glow` 
                : 'bg-cyber-card border-cyber-border hover:border-cyber-primary/30 hover:bg-cyber-cardHighlight'
            }`}
          >
             {/* Severity Indicator */}
             <div className={`p-3 rounded-xl shrink-0 ${config.bg} ${config.color} border ${config.border}`}>
                <Icon size={24} strokeWidth={2} />
             </div>

             <div className="flex-1 min-w-0">
                <div className="flex items-center gap-3 mb-1">
                    <h4 className="font-display font-bold text-cyber-text-main text-base truncate">{vuln.title}</h4>
                    <span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider ${config.bg} ${config.color} border ${config.border}`}>
                        {config.label}
                    </span>
                </div>
                {/* Simplified One-Liner Description for collapsed state */}
                {!isOpen && <p className="text-sm text-cyber-text-muted truncate">{vuln.description}</p>}
             </div>
             
             <ChevronDown size={20} className={`text-cyber-text-muted transition-transform duration-300 ${isOpen ? 'rotate-180 text-cyber-primary' : ''}`} />
          </div>

          {isOpen && (
            <div className="mt-3 pl-4 pr-1 pb-4 animate-fade-in relative">
                {/* Connecting Line */}
                <div className="absolute left-9 top-0 bottom-6 w-0.5 bg-cyber-border"></div>

                <div className="ml-10 space-y-6">
                    
                    {/* PLAIN ENGLISH EXPLANATION */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="cyber-card p-5 bg-cyber-cardHighlight border-cyber-border">
                             <h5 className="text-xs font-bold text-cyber-text-muted uppercase tracking-widest mb-3 flex items-center gap-2 font-display">
                                <HelpCircle size={14} className="text-cyber-primary" /> What is this?
                             </h5>
                             <p className="text-sm text-cyber-text-main leading-relaxed font-medium">
                                {vuln.description}
                             </p>
                        </div>
                        <div className="cyber-card p-5 bg-rose-500/5 border-rose-500/10">
                             <h5 className="text-xs font-bold text-rose-400 uppercase tracking-widest mb-3 flex items-center gap-2 font-display">
                                <Briefcase size={14} className="text-rose-400" /> Why it matters?
                             </h5>
                             <p className="text-sm text-cyber-text-main leading-relaxed font-medium">
                                {vuln.impact}
                             </p>
                        </div>
                    </div>

                    {/* REMEDIATION - LOCKED IF PLAN DOESN'T ALLOW */}
                    <div className="cyber-card p-0 border-emerald-500/20 overflow-hidden bg-cyber-card relative">
                        <div className="bg-emerald-500/10 p-4 border-b border-emerald-500/20 flex items-center gap-2">
                             <CheckCircle size={16} className="text-emerald-400" />
                             <h5 className="text-xs font-bold text-emerald-400 uppercase tracking-widest font-display">How to Fix</h5>
                        </div>
                        <div className={`p-5 relative ${!plan.showSolutions ? 'blur-sm select-none' : ''}`}>
                            <p className="text-sm text-cyber-text-secondary mb-4 leading-relaxed">
                                {plan.showSolutions ? vuln.fixExplanation : "Upgrade your plan to see detailed remediation steps and secure code snippets."}
                            </p>
                            
                            {(vuln.fixCode || !plan.showSolutions) && (
                                <div className="relative group/code">
                                    <div className="absolute top-2 right-2 opacity-0 group-hover/code:opacity-100 transition-opacity">
                                        <button 
                                            onClick={plan.showSolutions ? copyCode : undefined}
                                            className="p-1.5 bg-slate-800 hover:bg-slate-700 text-slate-400 rounded border border-slate-700 shadow-sm transition-colors"
                                        >
                                            {copied ? <CheckCircle size={14} className="text-emerald-400"/> : <Copy size={14}/>}
                                        </button>
                                    </div>
                                    <div className="bg-[#0B0F19] rounded-lg border border-slate-800 p-4 overflow-x-auto custom-scrollbar shadow-inner">
                                        <pre className="text-xs font-mono text-emerald-300 leading-relaxed">
                                            {plan.showSolutions ? vuln.fixCode : "function secureCode() {\n  return 'Upgrade to unlock';\n}"}
                                        </pre>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {!plan.showSolutions && (
                            <div className="absolute inset-0 flex items-center justify-center z-10 bg-black/20">
                                <button 
                                    onClick={() => setShowPricing(true)}
                                    className="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-xl flex items-center gap-2 transition-all"
                                >
                                    <Lock size={16} /> Unlock Solutions
                                </button>
                            </div>
                        )}
                    </div>

                    {/* TECHNICAL DETAILS (Advanced) */}
                    <div className="cyber-card bg-cyber-cardHighlight p-4 border-cyber-border">
                         <h5 className="text-[10px] font-bold text-cyber-text-muted uppercase tracking-widest mb-3 flex items-center gap-2">
                            <Terminal size={12} /> Technical Evidence (For Developers)
                         </h5>
                         <div className="flex flex-wrap gap-3 mb-3">
                             <span className="text-xs font-mono bg-cyber-bg border border-cyber-border px-2 py-1 rounded text-rose-400">
                                {vuln.affectedUrl}
                             </span>
                             {vuln.cwe && (
                                <span className="text-xs font-mono bg-cyber-bg border border-cyber-border px-2 py-1 rounded text-cyber-text-secondary">
                                    {vuln.cwe}
                                </span>
                             )}
                             {vuln.capec && (
                                <span className="text-xs font-mono bg-cyber-bg border border-cyber-border px-2 py-1 rounded text-cyber-text-secondary">
                                    {vuln.capec}
                                </span>
                             )}
                             {vuln.cvssScore && (
                                <span className="text-xs font-mono bg-cyber-bg border border-cyber-border px-2 py-1 rounded text-cyber-text-secondary">
                                    CVSS: {vuln.cvssScore}
                                </span>
                             )}
                         </div>
                         <pre className="text-xs font-mono text-cyber-text-secondary bg-cyber-bg p-3 rounded border border-cyber-border overflow-x-auto whitespace-pre-wrap shadow-inner">
                            {vuln.proofOfConcept}
                         </pre>
                    </div>
                </div>
            </div>
          )}
        </div>
    );
};

export const VulnerabilityList: React.FC<Props> = ({ vulnerabilities }) => {
  const [expandedId, setExpandedId] = useState<string | null>(null);

  return (
    <div className="space-y-4">
      {vulnerabilities.length === 0 && (
         <div className="cyber-card p-12 text-center flex flex-col items-center bg-cyber-card border-dashed border-cyber-border">
            <div className="w-16 h-16 bg-emerald-500/10 rounded-full flex items-center justify-center mb-4 border border-emerald-500/20">
                <ShieldCheck size={32} className="text-emerald-500" />
            </div>
            <h4 className="text-lg font-bold text-cyber-text-main font-display">System Secure</h4>
            <p className="text-cyber-text-muted text-sm mt-2 max-w-sm">
                Great news! Our scan didn't detect any automated vulnerabilities based on your current configuration.
            </p>
         </div>
      )}

      {vulnerabilities.map((vuln) => (
         <VulnerabilityItem 
            key={vuln.id} 
            vuln={vuln} 
            isOpen={expandedId === vuln.id} 
            onToggle={() => setExpandedId(expandedId === vuln.id ? null : vuln.id)} 
         />
      ))}
    </div>
  );
};
